
BB_output_file <- "BB multivariate log reg and cox reg output.doc"
sink(BB_output_file)



#first model:
multilogreg.fit <- glm(formula = Readmission ~ gender + AgeGrouped + ethnicity_grouped + type + bmi_status + consults + COPD + CVD + heart_failure + CKD + T1DM + T2DM + cerebrovasc_disease + stroke_hx + depression + anxiety + insomnia + polypharmacy + antipsych_meds + med_reviews + residential_care + e2015_imd_5, data=dementia_data, family=binomial(link="logit"))
summary(multilogreg.fit)



#Multicollinearity check of first model
library(car)
vif_values <- vif(multilogreg.fit)
print(vif_values)



#AIC-based model selection
#backward elimination
multi_aic_back <- step(multilogreg.fit, trace=0, direction="backward")
summary(multi_aic_back)

#forward elimination
fitted_null <- glm(formula = Readmission ~ 1, data=dementia_data, family=binomial(link="logit"))
multi_aic_forward <- step(fitted_null, scope=list(lower=fitted_null, upper=multilogreg.fit), trace=0, direction="forward")
summary(multi_aic_forward)

#forward and backward elimination combined
multi_aic_both <- step(multilogreg.fit, scope=list(lower=fitted_null, upper=multilogreg.fit), trace=0, direction="both")
summary(multi_aic_both)

#final model based on these (lowest AIC number: all models have same number so chose both - can choose any.)
final_log_reg <-glm(formula = Readmission ~ gender + AgeGrouped + ethnicity_grouped + type + consults + COPD + CVD + heart_failure 
                    + CKD + T1DM + T2DM + cerebrovasc_disease + stroke_hx + depression + antipsych_meds + med_reviews 
                    + residential_care, data=dementia_data, family=binomial(link="logit")) 
summary(final_log_reg)


#functions to get ORs and 95%CIs from LR models
oddsratio <- function(x) {exp(coef(x))}
oddsratioci <- function(x) {exp(confint(x))}

#get OR and 95%CIs of  model
cbind(oddsratio(final_log_reg), oddsratioci(final_log_reg))



#check vif of final model
vif_values_final <- vif(final_log_reg)
print(vif_values_final)

#covariates pattern - how many unique covariate combinations in the dataset
design_matrix <- model.matrix(final_log_reg)
covariates_pattern <- unique.matrix(design_matrix)
nrow(covariates_pattern)  #appropriate result for sample size, makes model stable with also handling multicollinearity with VIF




#Hosmer-Lemeshow test (goodness of fit)
library(blorr)
blr_test_hosmer_lemeshow(final_log_reg)

#AUC
library(pROC)

#get predicted probabilities of model
predicted_probs <- predict(final_log_reg, type = "response")

#calculate the ROC curve and AUC
roc_curve <- roc(dementia_data$Readmission, predicted_probs)

#get the AUC value
auc_value <- auc(roc_curve)
print(auc_value)


#plot ROC curve
gains_table <- blr_gains_table(final_log_reg)
blr_roc_curve(gains_table)






dev.off() #resets graphics device if graphs not showing



#MODEL 2: bmi missing data removed

multilogreg2.fit<- glm(Readmission ~ gender + AgeGrouped + ethnicity_grouped + type + bmi_status + consults
                       + COPD + CVD + heart_failure + CKD + T1DM + T2DM + cerebrovasc_disease + stroke_hx + depression
                       + anxiety + insomnia + polypharmacy + antipsych_meds + med_reviews + residential_care
                       + e2015_imd_5, data=dementia_data2, family=binomial(link="logit"))

summary(multilogreg2.fit)

#check VIF values
vif_values2 <- vif(multilogreg2.fit)
print(vif_values2)


#AIC-based model selection
#backward elimination
multi_aic_back2 <- step(multilogreg2.fit, trace=0, direction="backward")
summary(multi_aic_back2)

#forward elimination
fitted_null2 <- glm(formula = Readmission ~ 1, data=dementia_data2, family=binomial(link="logit"))
multi_aic_forward2 <- step(fitted_null2, scope=list(lower=fitted_null2, upper=multilogreg2.fit), trace=0, direction="forward")
summary(multi_aic_forward2)

#forward and backward elimination combined
multi_aic_both2 <- step(multilogreg2.fit, scope=list(lower=fitted_null2, upper=multilogreg2.fit), trace=0, direction="both")
summary(multi_aic_both2)

#final model based on these (lowest AIC number: all models have same number so chose both - can choose any.)
final_logreg2 <-glm(formula = Readmission ~ gender + AgeGrouped + ethnicity_grouped + type + consults + COPD + CVD 
                    + heart_failure + CKD + T1DM + T2DM + stroke_hx + depression + antipsych_meds + med_reviews 
                    + residential_care, data=dementia_data2, family=binomial(link="logit")) 
summary(final_logreg2)




#get OR and 95%CIs of  model
cbind(oddsratio(final_logreg2), oddsratioci(final_logreg2))



#check vif of final model
vif_values2 <- vif(final_logreg2)
print(vif_values2)



#covariates pattern - how many unique covariate combinations in the dataset
design_matrix2 <- model.matrix(final_logreg2)
covariates_pattern2 <- unique.matrix(design_matrix2)
nrow(covariates_pattern2)  #appropriate result for sample size, makes model stable with also handling multicollinearity with VIF



#Hosmer-Lemeshow test (goodness of fit)
blr_test_hosmer_lemeshow(final_logreg2) #generally good fit, observed outcomes not sig different to predicted outcomes (models predicted probs align well with the actual data)

#AUC
#get predicted probabilities of model
predicted_probs2 <- predict(final_logreg2, type = "response")

#calculate the ROC curve and AUC
roc_curve2 <- roc(dementia_data2$Readmission, predicted_probs2)

#get the AUC value
auc_value2 <- auc(roc_curve2)
print(auc_value2)


#plot ROC curve
gains_table2 <- blr_gains_table(final_logreg2)
blr_roc_curve(gains_table2)



#Model 2 AIC lower than model 1 AIC (34230 vs 39242) with reduced sample size in model 2
#suggests bmi data (or its missingness) may not add predictive value for readmissions, especially as bmi wasn't retained in either final model.
#therefore choose MODEL 2 as main model (better fit)



#MODEL 3
multilogreg3.fit<- glm(formula = Readmission ~ gender + AgeGrouped + ethnicity_grouped + type + consults + LTC_cat 
                       + antipsych_meds + med_reviews + residential_care, data=dementia_data2, family=binomial(link="logit"))

summary(multilogreg3.fit)


#check VIF values
vif_values3 <- vif(multilogreg3.fit)
print(vif_values3)



#AIC-based model selection
#backward elimination
multi_aic_back3 <- step(multilogreg3.fit, trace=0, direction="backward")
summary(multi_aic_back3)

#forward elimination
fitted_null3 <- glm(formula = Readmission ~ 1, data=dementia_data2, family=binomial(link="logit"))
multi_aic_forward3 <- step(fitted_null3, scope=list(lower=fitted_null3, upper=multilogreg3.fit), trace=0, direction="forward")
summary(multi_aic_forward3)

#forward and backward elimination combined
multi_aic_both3 <- step(multilogreg3.fit, scope=list(lower=fitted_null3, upper=multilogreg3.fit), trace=0, direction="both")
summary(multi_aic_both3)

#final model based on these (lowest AIC number: all models have same number so chose both - can choose any. chose both)
final_logreg3 <-glm(formula = Readmission ~ gender + AgeGrouped + ethnicity_grouped + type + consults
                    + LTC_cat + antipsych_meds + med_reviews + residential_care, data=dementia_data2, family=binomial(link="logit"))

summary(final_logreg3)



#get OR and 95%CIs of  model
cbind(oddsratio(final_logreg3), oddsratioci(final_logreg3))


#check vif of final model
vif_values3 <- vif(final_logreg3)
print(vif_values3)


#covariates pattern - how many unique covariate combinations in the dataset
design_matrix3 <- model.matrix(final_logreg3)
covariates_pattern3 <- unique.matrix(design_matrix3)
nrow(covariates_pattern3)  #appropriate result for sample size, makes model stable with also handling multicollinearity with VIF



#Hosmer-Lemeshow test (goodness of fit)
blr_test_hosmer_lemeshow(final_logreg3) #generally good fit, observed outcomes not sig different to predicted outcomes (models predicted probs align well with the actual data)

#AUC
#get predicted probabilities of model
predicted_probs3 <- predict(final_logreg3, type = "response")

#calculate the ROC curve and AUC
roc_curve3 <- roc(dementia_data2$Readmission, predicted_probs3)

#get the AUC value
auc_value3 <- auc(roc_curve3)
print(auc_value3)


#plot ROC curve
gains_table3 <- blr_gains_table(final_logreg3)
blr_roc_curve(gains_table3)

#####################################

#MODEL 4: Investigating the risk of death within 1 year of readmission

library(dplyr)
library(lubridate)

#create a dataset containing only cases with rapid readmission to look
#at outcomes relating to death after rapid readmission

dementia_data4 <- dementia_data3[!is.na(dementia_data3$admidate_1), ]

#Define end of follow up as earliest of death date (dod), tod, lcd, or study end date
dementia_data4 <- dementia_data4 %>%
  mutate(
    end_of_followup = as.Date(pmin(dod, tod, lcd, as.Date("2018-11-30"), na.rm = TRUE))
  )

#Define eligibility for readmission-death group
dementia_data4 <- dementia_data4 %>%
  mutate(
    eligible_readmit = !is.na(admidate_1) & admidate_1 <= end_of_followup
  )


#define 1-year window after readmission
dementia_data4 <- dementia_data4 %>% 
  mutate(
    end_1yr_readm = admidate_1 %m+% lubridate::years(1)
  )


#define event indicator: death within 1 year of readmission
dementia_data4 <- dementia_data4 %>% 
  mutate(
    died_1yr_readm = case_when(
      eligible_readmit & 
        !is.na(dod) & 
        dod >= admidate_1 &
        dod <= end_1yr_readm ~ 1,    #died within 1 yr of readm
      eligible_readmit ~ 0,          #survived to 1 year or was censored
      TRUE ~ NA_integer_             # not part of this subgroup
    )
  )

#define censoring date (excluding death, this is the event of interest)
dementia_data4 <- dementia_data4 %>% 
  mutate(
    censor_date_1yr = case_when(
      eligible_readmit ~ pmin(
        tod,
        lcd,
        as.Date("2018-11-30"),
        end_1yr_readm,
        na.rm = TRUE
      ),
      TRUE ~ as.Date(NA)
    )
  )

#Define time-to-event variable (days)
dementia_data4 <- dementia_data4 %>% 
  mutate(
    time_to_event = case_when(
      died_1yr_readm == 1 ~ as.numeric(dod - admidate_1),
      died_1yr_readm == 0 ~ as.numeric(censor_date_1yr - admidate_1),
      TRUE ~ NA_real_
    )
  )



#create a censoring indicator
dementia_data4 <- dementia_data4 %>% 
  mutate(
    censored = case_when(
      died_1yr_readm == 0 ~ "censored",
      died_1yr_readm == 1 ~ "died within 1 year",
      TRUE ~ NA_character_
    )
  )


#restrict to summary stats to the eligible subgroup
summary_stats <- dementia_data4 %>%
  filter(eligible_readmit) %>% 
  group_by(censored) %>%
  summarise(
    mean_age = mean(index_adm_age, na.rm = TRUE),
    
    prop_female = mean(gender == "Female", na.rm = TRUE),
    
    prop_white = mean(ethnicity_grouped == "White", na.rm = TRUE),
    prop_asian = mean(ethnicity_grouped == "Asian", na.rm = TRUE),
    prop_black = mean(ethnicity_grouped == "Black", na.rm = TRUE),
    prop_other = mean(ethnicity_grouped == "Other", na.rm = TRUE),
    
    prop_alzheimers = mean(type == "Alzheimers", na.rm = TRUE),
    prop_VaD = mean(type == "VaD", na.rm = TRUE),
    prop_DLB = mean(type == "DLB", na.rm = TRUE),
    prop_alcoholic = mean(type == "Alcoholic", na.rm = TRUE),
    prop_mixed = mean(type == "Mixed", na.rm = TRUE),
    prop_unspecified = mean(type == "Unspecified", na.rm = TRUE),
    
    prop_consults = mean(consults == "1", na.rm = TRUE),
    
    prop_LTC0 = mean(LTC_cat == "0", na.rm = TRUE),
    prop_LTC1 = mean(LTC_cat == "1", na.rm = TRUE),
    prop_LTC2_3 = mean(LTC_cat %in% c("2", "3"), na.rm = TRUE),
    prop_LTC4_5 = mean(LTC_cat %in% c("4","5"), na.rm = TRUE),
    prop_LTC6plus = mean(LTC_cat == "6+", na.rm = TRUE),
    
    prop_antipsychs = mean(antipsych_meds == "1", na.rm = TRUE),
    prop_medreviews = mean(med_reviews == "1", na.rm = TRUE),
    prop_res = mean(residential_care == "1", na.rm = TRUE),
    
    total_n = n()
  )


View(summary_stats)


#average time to readmission
dementia_data4 <- dementia_data4 %>%
  mutate(time_to_readmission = as.numeric(admidate_1 - admidate_0))

summary(dementia_data4$time_to_readmission)
sd(dementia_data4$time_to_readmission, na.rm=TRUE)

#how many readm pts died within one year
table(dementia_data4$died_1yr_readm)



#stats for time to death within 1yr readmission
summary(dementia_data4$time_to_event)
hist(dementia_data4$time_to_event)
sd(dementia_data4$time_to_event, na.rm = TRUE)




#fit cox models
library(survival)


cox_model1 <- coxph(Surv(time_to_event, died_1yr_readm) ~ gender + AgeGrouped + ethnicity_grouped + type + consults
                    + LTC_cat + antipsych_meds + med_reviews + residential_care,
                    data = dementia_data4 %>% filter(eligible_readmit))


summary(cox_model1)
exp(coef(cox_model1))

#test for cox regression assumption
cox.zph(cox_model1) # all variables have p>0.05 so model doesn't violate cox regression assumption


#29% incr risk of death wthn 1 yr of readmission (p=0.007) for pts in residential care.
#living in residential care reduce readmission risk in log reg models
#for those in res.care and with readmission, does the association of death within 1yr differ by age group?

#test interaction term with residential care:AgeGrouped to see if age acts as an effect modifier for res care and mortality
cox_model2 <- coxph(
  Surv(time_to_event, died_1yr_readm) ~ residential_care * AgeGrouped +
    gender + ethnicity_grouped + type + consults + LTC_cat +
    antipsych_meds + med_reviews,
  data = dementia_data4 %>% filter(eligible_readmit)
)
summary(cox_model2)     #no effect, all p-values insignificant



#stratify by age and perform cox reg without LTC_cat and with LTC_cat again to see if LTCs partially explain incr mortality risk
# no major difference in HR and p-values, therefore res care remains an independent factor of mortality beyond age and comorbidities
cox_model3 <- coxph(Surv(time_to_event, died_1yr_readm) ~ residential_care  + gender + ethnicity_grouped + type + consults
                    + antipsych_meds + med_reviews + strata(AgeGrouped), data = dementia_data4 %>% filter(eligible_readmit)
                    )

summary(cox_model3)


cox_model4 <- coxph(Surv(time_to_event, died_1yr_readm) ~ residential_care  + gender + ethnicity_grouped + type + consults
                    + LTC_cat + antipsych_meds + med_reviews + strata(AgeGrouped), data = dementia_data4 %>% filter(eligible_readmit)
                    )

summary(cox_model4)



#sensitivity test for informative censoring
#ensure censoring is defined correctly
d_sub <- dementia_data4 %>%
  filter(eligible_readmit) %>%
  mutate(
    censored = factor(
      ifelse(died_1yr_readm == 1, "Died within 1 year", "Censored")
    )
  )

#apply chi-square tests
chisq.test(table(d_sub$censored, d_sub$AgeGrouped))
chisq.test(table(d_sub$censored, d_sub$gender))
chisq.test(table(d_sub$censored, d_sub$ethnicity_grouped))
chisq.test(table(d_sub$censored, d_sub$type))
chisq.test(table(d_sub$censored, d_sub$consults))
chisq.test(table(d_sub$censored, d_sub$LTC_cat))
chisq.test(table(d_sub$censored, d_sub$antipsych_meds))
chisq.test(table(d_sub$censored, d_sub$med_reviews))
chisq.test(table(d_sub$censored, d_sub$residential_care))





#Main cohort person-years
dementia_data5 <- dementia_data2 %>%
  mutate(
    end_of_followup = as.Date(pmin(dod, tod, lcd, as.Date("2018-11-30"), na.rm = TRUE)),           #define end of follow up as the earliest death date, transfer-out date, last collection date, or study end date (nov 2018)
    end_of_followup = dplyr::if_else(end_of_followup < admidate_0, admidate_0, end_of_followup),   #ensure follow-up does not end before index adm. if so, reset it to index adm date
    person_years = as.numeric(difftime(end_of_followup, admidate_0, units = "days")) / 365         #calc person-yrs from index adm to end of follow up in days
  )

summary(dementia_data5$person_years)
sd(dementia_data5$person_years, na.rm = TRUE)
total_person_yrs1 <- sum(dementia_data5$person_years, na.rm = TRUE)
print(total_person_yrs1)


#Person-years for readmitted subset
dementia_data4 <- dementia_data4 %>%
  mutate(
    end_of_followup = as.Date(pmin(dod, tod, lcd, as.Date("2018-11-30"), na.rm = TRUE)),
    end_of_followup = dplyr::if_else(end_of_followup < admidate_0, admidate_0, end_of_followup),
    person_years = as.numeric(difftime(end_of_followup, admidate_0, units = "days")) / 365
  )

summary(dementia_data4$person_years)
sd(dementia_data4$person_years, na.rm = TRUE)
total_person_yrs2 <- sum(dementia_data4$person_years, na.rm = TRUE)
print(total_person_yrs2)


#Person-years for non-readmitted subset
dementia_data6 <- dementia_data6 %>%
  mutate(
    end_of_followup = as.Date(pmin(dod, tod, lcd, as.Date("2018-11-30"), na.rm = TRUE)),
    end_of_followup = dplyr::if_else(end_of_followup < admidate_0, admidate_0, end_of_followup),
    person_years = as.numeric(difftime(end_of_followup, admidate_0, units = "days")) / 365
  )

summary(dementia_data6$person_years)
sd(dementia_data6$person_years, na.rm = TRUE)

total_person_yrs3 <- sum(dementia_data6$person_years, na.rm = TRUE) 
print(total_person_yrs3)







sink()


